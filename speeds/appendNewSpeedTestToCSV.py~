#!/usr/bin/python

import re, mmap
import glob, os

#directory of timestamp-named HTM files directly from Cable Modem
dirName="/home/ed/Documents/CableModemStats/speeds"
modemFiles = glob.glob(dirName+"/*.txt")
modemFiles.sort(key=os.path.getmtime)

#all new data will be appended to a .csv file
csvFileName='speeds.csv'
csvFile=open(csvFileName,'a+')

# failureFileName='failedParse.txt'
# failureFile=open(failureFileName,'a+')

reDecimalNumberFollowedByMs="[0-9]{1,}\.[0-9]{1,} ms"
reDecimalNumberFollowedByMbitsPerS="[0-9]{1,}\.[0-9]{1,} Mbits/s"
reLinesStartingWithHosted="Hosted by .*"
reWordsNumsCommasAndDots="[0-9A-Za-z ,\.-]*"

headerLine="Time,Ping (ms),Download Speed (Mbits/s),Upload Speed (Mbits/s),Host,Host Location,Host Distance (km)"
print >> csvFile, headerLine

# modemFiles=["/home/ed/Documents/CableModemStats/speeds/1416586021.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418781721.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426503722.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432004521.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416586321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418785321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426507321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432008121.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416586621.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418788921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426510921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432011721.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416586921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418792521.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426514521.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432015321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416587221.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418796121.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426518121.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432018921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416587521.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418799721.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426521721.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432022521.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416587821.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418803321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426525321.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432026121.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1416588121.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1418806921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1426528921.txt",
#             "/home/ed/Documents/CableModemStats/speeds/1432029721.txt"]
# y=["x"]
# for x in y:
for modemFile in modemFiles:
    # modemfile="/home/ed/Documents/CableModemStats/speeds/1424350921.txt"
    f=open(modemFile,'r+')
    try:

        lineToAppendToCSV=modemFile.replace("/home/ed/Documents/CableModemStats/speeds/","").replace(".txt","")+","
       
        fulltext=f.read()

        ping = re.search(reDecimalNumberFollowedByMs,fulltext)
        speeds = re.findall(reDecimalNumberFollowedByMbitsPerS,fulltext)
        hostedLine = re.search(reLinesStartingWithHosted,fulltext)

        hostName=None
        hostLoc=None
        hostDist=None
        if (hostedLine != None):
            hostList = re.findall(reWordsNumsCommasAndDots,hostedLine.group())
            hostName = hostList[0].replace("Hosted by","").strip().replace(",",";")
            hostLoc  = hostList[2].replace(",",";")
            hostDist = hostList[6].replace(" km","")
        else :
            hostName = "N/A"
            hostLoc  = "N/A"
            hostDist = "N/A"

        if ping == None:
            ping = "N/A"
        else :
            ping = ping.group().replace(" ms","")

        if len(speeds) != 2:
            speeds=["N/A","N/A"]

        lineToAppendToCSV+="{},".format(ping)
        lineToAppendToCSV+="{},".format(speeds[0].replace(" Mbits/s",""))
        lineToAppendToCSV+="{},".format(speeds[1].replace(" Mbits/s",""))
        lineToAppendToCSV+="{},".format(hostName)
        lineToAppendToCSV+="{},".format(hostLoc)
        lineToAppendToCSV+="{},".format(hostDist)
    
        print >>csvFile, lineToAppendToCSV.rstrip(",")
                    
    finally:
        f.close()
quit()
